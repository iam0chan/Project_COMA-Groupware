<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chatting">
	<!-- resultMap -->
	<resultMap type="chattingRoom" id="chattingRoomMap">
		<id column="ROOM_NO" property="roomNo"/>
		<result column="ROOM_NAME" property="roomName"/>
		<result column="ROOM_PASSWORD_FLAG" property="roomPasswordFlag"/>
		<result column="ROOM_PASSWORD" property="roomPassword"/>
		<result column="ROOM_CREATE_DATE" property="roomCreateDate"/>		
		<result column="MEMBER_COUNT" property="memberCount"/>
		<association property="roomTypeObj" resultMap="chattingRoomTypeMap"/>
	</resultMap>
	
	<resultMap type="chattingMessage" id="chattingMessageMap">
		<id column="CHAT_NO" property="chatNo"/>
		<result column="CHAT_CONTENT" property="chatContent"/>
		<result column="CHAT_CREATE_DATE" property="chatCreateDate"/>
		<result column="EMP_ID" property="empId"/>
		<result column="ROOM_NO" property="roomNo"/>
		<association property="empObj" resultMap="emp.empMap"/>
		<association property="roomObj" resultMap="chattingRoomMap"/>
	</resultMap>
	
	<resultMap type="chattingRoomType" id="chattingRoomTypeMap">
		<id column="ROOM_TYPE" property="roomType"/>
		<result column="ROOM_TYPE_NAME" property="roomTypeName"/>
	</resultMap>
	
	<resultMap type="chattingJoin" id="chattingJoinMap">
		<result column="NEW_JOIN" property="newJoin"/>
		<association property="roomObj" resultMap="chattingRoomMap"/>
		<association property="empObj" resultMap="emp.empMap"/>
	</resultMap>
	
	
	
	<!-- select --> 
	
	
	<select id="selectRoomList" resultMap="chattingRoomMap">
		SELECT R.*, T.*, (SELECT COUNT(*) FROM CHAT_JOIN J GROUP BY ROOM_NO HAVING R.ROOM_NO = J.ROOM_NO) AS MEMBER_COUNT
		FROM CHAT_ROOM R LEFT JOIN CHAT_ROOM_TYPE T ON R.ROOM_TYPE = T.ROOM_TYPE 
		ORDER BY ROOM_CREATE_DATE DESC 
	</select>
	<select id="selectRoomPasswordCheck" parameterType="map" resultMap="chattingRoomMap">
		SELECT * FROM CHAT_ROOM LEFT JOIN CHAT_ROOM_TYPE USING (ROOM_TYPE) WHERE ROOM_NO = #{roomNo} AND ROOM_PASSWORD = #{password}
	</select>
	
	<select id="selectCheckJoin" parameterType="map" resultMap="chattingJoinMap">
		SELECT * FROM CHAT_JOIN WHERE ROOM_NO = #{roomNo} AND EMP_ID = #{empId}
	</select>
	
	<!-- SELECT * FROM CHAT_JOIN LEFT JOIN EMP using(emp_id) WHERE ROOM_NO = 'CR_1060'; -->
	<select id="selectRoomMemberList" parameterType="string" resultMap="chattingJoinMap">
		SELECT * FROM CHAT_JOIN LEFT JOIN EMP USING(EMP_ID) JOIN JOB USING(JOB_CODE) WHERE ROOM_NO = #{roomNo}
	</select>
	
	<select id="selectChatRoomListByType" parameterType="string" resultMap="chattingRoomMap">
		SELECT R.*, T.*, (SELECT COUNT(*) FROM CHAT_JOIN J GROUP BY ROOM_NO HAVING R.ROOM_NO = J.ROOM_NO) AS MEMBER_COUNT 
		FROM CHAT_ROOM R LEFT JOIN CHAT_ROOM_TYPE T ON R.ROOM_TYPE = T.ROOM_TYPE
		
		<where>
			<if test="type!=null and type!='ALL'">
				T.ROOM_TYPE = #{type}
			</if>
		</where>
		ORDER BY ROOM_CREATE_DATE DESC 
	</select>
	
	<select id="selectMyJoinRoomById" parameterType="string" resultType="string">
		SELECT ROOM_NO FROM CHAT_JOIN WHERE EMP_ID = #{loginId}
	</select>
	
	<select id="selectChatMessageByRoomNo" parameterType="string" resultMap="chattingMessageMap">
		SELECT * FROM CHAT_MESSAGE JOIN EMP USING(EMP_ID) JOIN CHAT_ROOM USING(ROOM_NO) WHERE ROOM_NO = #{roomNo} ORDER BY CHAT_CREATE_DATE ASC
	</select>
	
	<select id="selectRoomByRoomNo" parameterType="string" resultMap="chattingRoomMap">
		SELECT * FROM CHAT_ROOM LEFT JOIN CHAT_ROOM_TYPE USING (ROOM_TYPE) WHERE ROOM_NO = #{roomNo}	
	</select>
	
	<select id="selectEmpByEmpId" parameterType="string" resultMap="emp.empMap">
		SELECT * FROM EMP JOIN DEPT USING(DEPT_CODE) JOIN JOB USING (JOB_CODE)WHERE EMP_ID = #{empId}
	</select>
	
	<select id="selectJoinCheckByEmpId" parameterType="map" resultMap="chattingJoinMap">
		SELECT * FROM EMP JOIN CHAT_JOIN USING(EMP_ID) WHERE ROOM_NO = #{roomNo} AND EMP_ID = #{empId}
	
	</select>
	
	<select id="selectNowCreateChatRoomNo" resultType="string">
		SELECT 'CR_'||SEQ_CHATROOM_NO.CURRVAL FROM DUAL
	</select>
	
	<!-- insert -->
	<insert id="insertCreateRoom" parameterType="chattingRoom">
		<if test='roomPasswordFlag != null and roomPasswordFlag eq "Y"'>
			INSERT INTO CHAT_ROOM VALUES('CR_'||SEQ_CHATROOM_NO.NEXTVAL,#{roomName},#{roomTypeObj.roomType},#{roomPasswordFlag},#{roomPassword},SYSTIMESTAMP)
		</if>
		<if test='roomPasswordFlag != null and roomPasswordFlag eq "N"'>
			INSERT INTO CHAT_ROOM VALUES('CR_'||SEQ_CHATROOM_NO.NEXTVAL,#{roomName},#{roomTypeObj.roomType},#{roomPasswordFlag},NULL,SYSTIMESTAMP)
		</if>
	</insert>
	
	<insert id="insertJoinEmp" parameterType="map">
		<choose>
			<when test='roomNo!=null and roomNo!=""'> 
				INSERT INTO CHAT_JOIN(ROOM_NO,EMP_ID) VALUES (#{roomNo}, #{empId}) 
			</when>
			<otherwise>
				<foreach collection="_parameter.entrySet()" item="id" index="key" open="INSERT ALL" separator=" " close="SELECT * FROM DUAL">
					INTO CHAT_JOIN(ROOM_NO,EMP_ID) VALUES('CR_'||SEQ_CHATROOM_NO.CURRVAL,#{id})
				</foreach>
				<!-- INSERT INTO CHAT_JOIN(ROOM_NO,EMP_ID) VALUES ('CR_'||SEQ_CHATROOM_NO.CURRVAL, #{empId}) -->
			</otherwise>
		</choose>
	</insert>
	
	<insert id="insertChattingMessage" parameterType="java.util.List" >
		<!-- INSERT ALL INTO CHAT_MESSAGE(CHAT_NO,CHAT_CONTENT,CHAT_CREATE_DATE,EMP_ID,ROOM_NO) VALUES -->
		<!-- ('CM_'||SEQ_CHAT_NO.NEXTVAL,#{chatContent},#{chatCreateDate},#{empId},#{roomNo}) -->
		<foreach collection="list" item="msg" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL" index="index">
			INTO CHAT_MESSAGE VALUES ('CM_'||SEQ_CHAT_NO.NEXTVAL||#{index},#{msg.chatContent},#{msg.chatCreateDate},#{msg.empId},#{msg.roomNo})
		</foreach>	
		
	</insert>
	<!-- update -->
	<update id="updateChatNewJoin" parameterType="map">
		UPDATE CHAT_JOIN SET NEW_JOIN = 'N' WHERE ROOM_NO = #{roomNo} AND EMP_ID = #{empId}  
	
	</update>
	
	
	<!-- delete -->
	
	<delete id="deleteChatRoomJoinEmpById" parameterType="map">
		DELETE CHAT_JOIN WHERE ROOM_NO = #{roomNo} and EMP_ID = #{empId}
	</delete>
	
	<delete id="deleteChattingMsgByRoomNoAndEmpId" parameterType="map">
		DELETE CHAT_MESSAGE WHERE ROOM_NO = #{roomNo} AND EMP_ID = #{empId}
	</delete>
	
	<delete id="deleteChattingMessage" parameterType="list">
		DELETE CHAT_MESSAGE WHERE ROOM_NO IN 
		<foreach collection="list" item="roomNo" separator="," open="(" close=")" >
			#{roomNo}
		</foreach>
	</delete>
	
	<delete id="deleteChattingRoomMember" parameterType="list">
		DELETE CHAT_JOIN WHERE ROOM_NO IN
		<foreach collection="list" item="roomNo" separator="," open="(" close=")">
			#{roomNo}
		</foreach>
	</delete>
	
	<delete id="deleteChattingRoom" parameterType="list">
		DELETE CHAT_ROOM WHERE ROOM_NO IN
		<foreach collection="list" item="roomNo" separator="," open="(" close=")">
			#{roomNo}
		</foreach>
	</delete>
</mapper>
